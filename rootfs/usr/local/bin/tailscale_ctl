#!/bin/bash -e

start_tailscale() {
	# Start tailscaled with userspace tunneling - required for running in a container
	tailscaled -tun userspace-networking &

	authkey="$(sops --decrypt --extract '["tailscale_oauth_client_secret"]' /mnt/workspace/source/config/secrets/global.yaml)"
	tailscale up --authkey="${authkey}" --advertise-tags tag:ci
}

stop_tailscale() {
	tailscale down
	killall tailscaled
}

"$@"
